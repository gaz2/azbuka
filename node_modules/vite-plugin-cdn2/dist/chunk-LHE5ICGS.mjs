import{a as T,b as H}from"./chunk-COPPLNKX.mjs";var W=T((ye,D)=>{"use strict";var{bind:K,call:Y}=Function.prototype,Z=K.bind(Y);D.exports.uncurryThis=Z;var ee=Object.getPrototypeOf(Uint8Array.prototype);D.exports.TypedArrayPrototype=ee;var re=(i,e,s,o)=>{if(e in i){if(o===!0){if(i[e]===s)return}else if(!(typeof o=="function"&&Object.prototype.toString.call(o)==="[object Function]")||!o())return}Object.defineProperty(i,e,{configurable:!0,enumerable:!1,value:s,writable:!0})},O=(i,e,s={})=>{let o=Array.prototype.concat.call(Object.keys(e),Object.getOwnPropertySymbols(e));for(let t=0,a=o.length;t<a;t++)re(i,o[t],e[o[t]],s[o[t]])};D.exports.defineProperties=O;var te=(i,e)=>O(i,{implementation:e,getPolyfill:()=>e,shim:()=>e});D.exports.makeEsShim=te});var q=T((he,C)=>{"use strict";var{makeEsShim:ne}=W(),F=typeof AggregateError=="function"?AggregateError:(()=>{function i(e,s){let o=new Error(s);return Object.setPrototypeOf(o,i.prototype),delete o.constructor,Object.defineProperty(o,"errors",{value:Array.from(e)}),o}return Object.defineProperty(i,"prototype",{writable:!1}),Object.defineProperties(i.prototype,{constructor:{enumerable:!1,configurable:!0,writable:!0,value:i},message:{enumerable:!1,configurable:!0,writable:!0,value:""},name:{enumerable:!1,configurable:!0,writable:!0,value:"AggregateError"}}),Object.setPrototypeOf(i.prototype,Error.prototype),i})(),R=F;ne(R,F);C.exports=R});import J from"fs/promises";import S from"url";import de from"module";import fe from"path";import w from"worker_threads";import{parse as ae}from"rs-module-lexer";import{parse as B,types as r,transformFromAstAsync as ce,traverse as z}from"@babel/core";var $=H(q());import _ from"path";import oe from"fs";import ie from"os";import se from"process";function v(i,e){let s=_.dirname(i),o=_.join(s,e);return oe.existsSync(o)?o:v(s,e)}function y(i){return i.length}function De(i){return Array.from(new Set(i))}function Pe(){let[i,e]=se.versions.node.split(".");return+i<12||+i==12&&+e<17||+i==13&&+e<13?[!1,`${i}.${e}`]:[!0,`${i}.${e}`]}function V(i,e){if(!i)throw new Error(e)}var I=new Function("specifier","return import(specifier)");function ve(i,e){return e.forEach((s,o)=>{let t=new RegExp(`require\\((["'\`])\\s*${o}\\s*(\\1)\\)`,"g");i=i.replace(t,s.global)}),i}var L=(()=>{let i=ie.cpus()||{length:1};return Math.max(1,i.length-1)})(),N=class{maxConcurrent;queue;running;errors;constructor(e){this.maxConcurrent=e,this.queue=[],this.running=0,this.errors=[]}enqueue(e){this.queue.push(e),this.run()}async run(){for(;this.running<this.maxConcurrent&&this.queue.length;){let e=this.queue.shift();this.running++;try{await e?.()}catch(s){this.errors.push(s)}finally{this.running--,this.run()}}}async wait(){for(;this.running;)await new Promise(e=>setTimeout(e,0));if(y(this.errors))throw new $.default(this.errors,"failed")}};function U(i){return new N(i)}function le(i){return r.isProgram(i.parent)||r.isExportDefaultDeclaration(i.parent)||r.isExportNamedDeclaration(i.parent)}var k=class{dependencies;aliasesToDependencies;injectDependencies(e){this.dependencies=e,this.aliasesToDependencies=new Map,this.dependencies.forEach(({name:s,aliases:o})=>{this.aliasesToDependencies.set(s,s),y(o)&&o.forEach(t=>this.aliasesToDependencies.set(t,s))})}filter(e,s){let{output:o}=ae({input:[{filename:s,code:e}]});if(!y(o))return!1;let{imports:t}=o[0],a=Array.from(new Set([...t.map(n=>n.n)]));for(let n of a)if(this.aliasesToDependencies.has(n))return!0;return!1}scanImportDeclarationAndRecord(e,s){let o=this.aliasesToDependencies.get(e.node.source.value),{global:t}=this.dependencies.get(o);for(let a of e.node.specifiers)switch(a.type){case"ImportDefaultSpecifier":case"ImportNamespaceSpecifier":s.set(a.local.name,`${t}.${a.type}.${o}`);break;case"ImportSpecifier":a.imported.type==="Identifier"&&s.set(a.local.name,`${t}.${a.imported.name}.${o}`)}}overWriteExportNamedDeclaration(e,s){let o=[],t=[],a=e.node.source,n=a?this.aliasesToDependencies.get(e.node.source.value):"",l=a&&n?this.dependencies.get(n).global:"",d=a&&n?this.dependencies.get(n).bindings:new Set,x=(c,f,g)=>{if(d.size){if(c.name==="default"&&c.name!==f.name){let p=h=>r.memberExpression(r.identifier(l),r.identifier(h)),u=[...d.keys()].map(h=>r.objectProperty(r.identifier(h),p(h))),m=r.variableDeclarator(r.identifier(f.name),r.objectExpression(u));o.push(m);return}if(f.name==="default"&&c.name!==f.name){let p=r.memberExpression(r.identifier(l),r.identifier(c.name));o.push(p);return}if(c.name===f.name){if(c.name==="default"){let p=h=>r.memberExpression(r.identifier(l),r.identifier(h)),u=[...d.keys()].map(h=>r.objectProperty(r.identifier(h),p(h))),m=r.objectExpression(u);o.push(m);return}if(d.has(c.name)){let p=r.memberExpression(r.identifier(l),r.identifier(c.name)),u=r.variableDeclarator(r.identifier(c.name),p);o.push(u);return}}t.push(g)}},b=(c,f,g)=>{if(s.has(c.name)){let[p,u,m]=s.get(c.name).split("."),h=(()=>{if(u==="ImportNamespaceSpecifier"){let A=P=>r.memberExpression(r.identifier(p),r.identifier(P));return r.objectExpression([...this.dependencies.get(m).bindings.keys()].map(P=>r.objectProperty(r.identifier(P),A(P))))}return r.memberExpression(r.identifier(p),r.identifier(u))})();f.name==="default"?o.push(h):o.push(r.variableDeclarator(r.identifier(c.name),h));return}t.push(g)};for(let c of e.node.specifiers){if(c.type==="ExportSpecifier"){let{local:f,exported:g}=c;if(g.type!=="Identifier")continue;a?x(f,g,c):b(f,g,c)}if(c.type==="ExportNamespaceSpecifier"){let f=c.exported;if(f.name==="default"){let g=m=>r.memberExpression(r.identifier(l),r.identifier(m)),p=[...d.keys()].map(m=>r.objectProperty(r.identifier(m),g(m))),u=r.objectExpression(p);o.push(u)}else{let g=m=>r.memberExpression(r.identifier(l),r.identifier(m)),p=[...d.keys()].map(m=>r.objectProperty(r.identifier(m),g(m))),u=r.variableDeclarator(r.identifier(f.name),r.objectExpression(p));o.push(u)}}}let E=o.filter(c=>c.type==="VariableDeclarator"),M=o.filter(c=>c.type!=="VariableDeclarator");if(y(M)){let c=r.exportDefaultDeclaration(M[0]);y(E)||y(t)?e.insertAfter(c):e.replaceWith(c)}if(y(E)){let c=r.variableDeclaration("var",E);if(y(t)){let f=r.exportNamedDeclaration(null,t);e.replaceWith(f),e.insertAfter(r.exportNamedDeclaration(c,[]))}else e.replaceWith(r.exportNamedDeclaration(c,[]))}}overWriteExportAllDeclaration(e){let s=[],o=this.aliasesToDependencies.get(e.node.source.value),{bindings:t}=this.dependencies.get(o);if(t.forEach(a=>{let n=r.identifier(a),l=r.exportSpecifier(n,n);s.push(l)}),y(s)){let a=r.exportNamedDeclaration(null,s,r.stringLiteral(e.node.source.value));e.replaceWith(a)}}eraseDuplicatedVariableDeclaration(e,s){if(!Array.isArray(e))return;let o=t=>{if(!Array.isArray(t)){if(r.isVariableDeclarator(t.node)&&((r.isObjectPattern(t.node.id)||r.isArrayPattern(t.node.id))&&o(t.get("id")),r.isRestElement(t.node.id)&&o(t.get("id.argument")),r.isIdentifier(t.node.id))){let a=t.node.id.name;s.has(a)&&s.get(a).remove(),s.set(a,t);return}if(r.isObjectPattern(t.node))for(let a of t.get("properties"))o(a);if(r.isArrayPattern(t.node))for(let a of t.get("elements"))o(a)}};for(let t of e)o(t)}async transform(e){let s=await B(e,{babelrc:!1,configFile:!1}),o=new Map,t=new Map;z(s,{ImportDeclaration:{enter:n=>{this.aliasesToDependencies.has(n.node.source.value)&&this.scanImportDeclarationAndRecord(n,o)},exit:n=>{this.aliasesToDependencies.has(n.node.source.value)&&(n.remove(),n.skip())}},ExportDeclaration:{enter:n=>{switch(n.node.type){case"ExportDefaultDeclaration":r.isIdentifier(n.node.declaration)&&this.aliasesToDependencies.has(n.node.declaration.name)&&n.remove();break;case"ExportNamedDeclaration":(this.aliasesToDependencies.has(n.node.source?.value)||!n.node.declaration)&&this.overWriteExportNamedDeclaration(n,o);break;case"ExportAllDeclaration":this.aliasesToDependencies.has(n.node.source.value)&&this.overWriteExportAllDeclaration(n)}}},Declaration:n=>{if(le(n)){if(r.isClassDeclaration(n.node)||r.isFunctionDeclaration(n.node)){let l=n.node.id.name;t.has(l)&&t.get(l).remove(),t.set(l,n)}r.isVariableDeclaration(n.node)&&this.eraseDuplicatedVariableDeclaration(n.get("declarations"),t)}},Identifier:n=>{if(r.isReferenced(n.node,n.parent)&&o.has(n.node.name)&&!n.scope.hasBinding(n.node.name)){let[l,d]=o.get(n.node.name).split(".");d==="ImportNamespaceSpecifier"||d==="ImportDefaultSpecifier"?n.node.name=l:n.node.name=[l,d].join("."),n.skip()}}});let a=await ce(s,"",{babelrc:!1,configFile:!1,sourceMaps:!0});return{code:a.code,map:a.map}}};function Se(){return new k}async function G(i){let e=await B(i,{babelrc:!1,configFile:!1}),{body:s}=e.program;if(!y(s))return;let o=s[0];if(r.isVariableDeclaration(o)){let n=o.declarations[0].id;if(r.isIdentifier(n))return n.name}let t=new Set,a="";return z(e,{ExpressionStatement:n=>{if(r.isCallExpression(n.node.expression)&&r.isFunctionExpression(n.node.expression.callee)){let l=n.node.expression.callee.params;y(l)&&l.forEach(d=>{d.type==="Identifier"&&t.add(d.name)})}},AssignmentExpression:n=>{let l=n.get("left");if(l.node.type==="MemberExpression"&&(n.parent.type==="CallExpression"||n.parent.type==="ConditionalExpression"||n.parent.type==="ExpressionStatement")&&!a){if(r.isIdentifier(l.node.object)&&!t.has(l.node.object.name)||!r.isIdentifier(l.node.property)||l.node.property.name==="exports")return;a=l.node.property.name}n.skip()}}),a}var Q=de.createRequire(import.meta.url),pe=S.fileURLToPath(import.meta.url);function ue(i,e){let{port1:s,port2:o}=new w.MessageChannel,t=new w.Worker(pe,{workerData:{workerPort:o,internalThread:!0,scannerModule:i.modules,defaultWd:e},transferList:[o],execArgv:[]}),a=0;return t.unref(),(()=>{let l=new SharedArrayBuffer(4),d=new Int32Array(l);t.postMessage({sharedBuffer:l,id:a});let x=Atomics.wait(d,0,0);if(x!=="ok"&&x!=="not-equal")throw new Error("Internal error: Atomics.wait() failed: "+x);let{message:b}=w.receiveMessageOnPort(s);if(b.id!==a)throw new Error(`Internal error: Expected id ${a} but got id ${b.id}`);if(b.error)throw b.error;let{bindings:E,failedModules:M}=b;return E.forEach((c,f)=>{i.resolvers[f]&&(c.resolve=i.resolvers[f])}),{dependencies:E,failedModules:M}})()}function X(i,e=[]){return e.filter(s=>s!==".").map(s=>fe.posix.join(i,s))}async function me(...i){let e;switch(y(i)){case 1:{let t=i[0];if(typeof t!="string")throw new Error("Invalid type");e=await I(S.pathToFileURL(t));break}case 2:{let[t,a]=i;if(typeof t!="object")throw new Error("Invalid type");let n=Q.resolve(t.name,{paths:[a]});e=await I(S.pathToFileURL(n));break}}let s=Object.keys(e);if(s.includes("default")&&y(s)!==1){let t=s.findIndex(a=>a==="default");s.splice(t,1),s.push(...Object.keys(e.default))}return new Set(s.filter(t=>t!=="__esModule"))}async function ge(i,e,s,o){let{name:t,relativeModule:a,aliases:n,...l}=i;try{let d=Q.resolve(t,{paths:[o]}),x=v(d,"package.json"),b=await J.readFile(x,"utf8"),E=JSON.parse(b),{version:M,name:c,unpkg:f,jsdelivr:g}=E,p=Object.create(null),u=a||g||f;if(!u)throw new Error("try resolve file failed.");if(l.global)Object.assign(p,{name:c,version:M,relativeModule:u,aliases:X(c,n),...l});else{let h=v(x,u),A=await J.readFile(h,"utf8");Object.assign(p,{name:c,version:M,code:A,relativeModule:u,aliases:X(c,n),...l})}let m=await me(d);e.set(c,{...p,bindings:m})}catch(d){let x=(()=>d instanceof Error?"code"in d&&d.code==="MODULE_NOT_FOUND"?"can't find module.":d.message:d)();s.set(t,x)}}function be(){if(!w.workerData.internalThread)return;let{workerPort:i,scannerModule:e,defaultWd:s}=w.workerData,{parentPort:o}=w,t=new Map,a=new Map;o?.on("message",n=>{(async()=>{let{id:l,sharedBuffer:d}=n,x=new Int32Array(d);try{let b=new Map,E=U(L);for(let M of e)E.enqueue(()=>ge(M,t,a,s));await E.wait();for(let M of e){let{name:c}=M;if(t.has(c)){let{code:f,...g}=t.get(c);if(!f){b.set(c,g);continue}let p=await G(f);p?b.set(c,{...g,global:p}):a.set(c,"try resolve global name failed.")}}t.clear(),i.postMessage({bindings:b,id:l,failedModules:a})}catch(b){i.postMessage({error:b,id:l})}Atomics.add(x,0,1),Atomics.notify(x,0,1/0)})()})}w.workerData?.internalThread&&be();var j=class{modules;dependencies;failedModules;defaultWd;constructor(e){this.modules=e,this.dependencies=new Map,this.failedModules=new Map,this.defaultWd=process.cwd()}setDefaultWd(e){this.defaultWd=e}scanAllDependencies(){let e=ue(this.serialization(this.modules),this.defaultWd);this.dependencies=e.dependencies,this.failedModules=e.failedModules}serialization(e){V(Array.isArray(e),"vite-plugin-cdn2: option module must be array");let s=[],o={},t=new Set;for(let a of e){if(typeof a=="string"){if(t.has(a)||!a)continue;s.push({name:a}),t.add(a);continue}if(!a.name||t.has(a.name))continue;let{resolve:n,...l}=a;n&&(o[l.name]=n),s.push(l),t.add(a.name)}return{modules:s,resolvers:o}}};function _e(i){return new j(i)}export{De as a,Pe as b,ve as c,Se as d,me as e,_e as f};
