"use strict";Object.defineProperty(exports, "__esModule", {value: true}); function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; } function _optionalChain(ops) { let lastAccessLHS = undefined; let value = ops[0]; let i = 1; while (i < ops.length) { const op = ops[i]; const fn = ops[i + 1]; i += 2; if ((op === 'optionalAccess' || op === 'optionalCall') && value == null) { return undefined; } if (op === 'access' || op === 'optionalAccess') { lastAccessLHS = value; value = fn(value); } else if (op === 'call' || op === 'optionalCall') { value = fn((...args) => value.call(lastAccessLHS, ...args)); lastAccessLHS = undefined; } } return value; }const __meta = /* @__PURE__ */{ url: require('url').pathToFileURL(__filename).href };
var _chunk4BZQND6Xjs = require('./chunk-4BZQND6X.js');var W=_chunk4BZQND6Xjs.a.call(void 0, (ye,D)=>{"use strict";var{bind:K,call:Y}=Function.prototype,Z=K.bind(Y);D.exports.uncurryThis=Z;var ee=Object.getPrototypeOf(Uint8Array.prototype);D.exports.TypedArrayPrototype=ee;var re=(i,e,s,o)=>{if(e in i){if(o===!0){if(i[e]===s)return}else if(!(typeof o=="function"&&Object.prototype.toString.call(o)==="[object Function]")||!o())return}Object.defineProperty(i,e,{configurable:!0,enumerable:!1,value:s,writable:!0})},O=(i,e,s={})=>{let o=Array.prototype.concat.call(Object.keys(e),Object.getOwnPropertySymbols(e));for(let t=0,a=o.length;t<a;t++)re(i,o[t],e[o[t]],s[o[t]])};D.exports.defineProperties=O;var te=(i,e)=>O(i,{implementation:e,getPolyfill:()=>e,shim:()=>e});D.exports.makeEsShim=te});var q=_chunk4BZQND6Xjs.a.call(void 0, (he,C)=>{"use strict";var{makeEsShim:ne}=W(),F=typeof AggregateError=="function"?AggregateError:(()=>{function i(e,s){let o=new Error(s);return Object.setPrototypeOf(o,i.prototype),delete o.constructor,Object.defineProperty(o,"errors",{value:Array.from(e)}),o}return Object.defineProperty(i,"prototype",{writable:!1}),Object.defineProperties(i.prototype,{constructor:{enumerable:!1,configurable:!0,writable:!0,value:i},message:{enumerable:!1,configurable:!0,writable:!0,value:""},name:{enumerable:!1,configurable:!0,writable:!0,value:"AggregateError"}}),Object.setPrototypeOf(i.prototype,Error.prototype),i})(),R=F;ne(R,F);C.exports=R});var _promises = require('fs/promises'); var _promises2 = _interopRequireDefault(_promises);var _url = require('url'); var _url2 = _interopRequireDefault(_url);var _module = require('module'); var _module2 = _interopRequireDefault(_module);var _path = require('path'); var _path2 = _interopRequireDefault(_path);var _worker_threads = require('worker_threads'); var _worker_threads2 = _interopRequireDefault(_worker_threads);var _rsmodulelexer = require('rs-module-lexer');var _core = require('@babel/core');var $=_chunk4BZQND6Xjs.b.call(void 0, q());var _fs = require('fs'); var _fs2 = _interopRequireDefault(_fs);var _os = require('os'); var _os2 = _interopRequireDefault(_os);var _process = require('process'); var _process2 = _interopRequireDefault(_process);function v(i,e){let s=_path2.default.dirname(i),o=_path2.default.join(s,e);return _fs2.default.existsSync(o)?o:v(s,e)}function y(i){return i.length}function De(i){return Array.from(new Set(i))}function Pe(){let[i,e]=_process2.default.versions.node.split(".");return+i<12||+i==12&&+e<17||+i==13&&+e<13?[!1,`${i}.${e}`]:[!0,`${i}.${e}`]}function V(i,e){if(!i)throw new Error(e)}var I=new Function("specifier","return import(specifier)");function ve(i,e){return e.forEach((s,o)=>{let t=new RegExp(`require\\((["'\`])\\s*${o}\\s*(\\1)\\)`,"g");i=i.replace(t,s.global)}),i}var L=(()=>{let i=_os2.default.cpus()||{length:1};return Math.max(1,i.length-1)})(),N=class{constructor(e){this.maxConcurrent=e,this.queue=[],this.running=0,this.errors=[]}enqueue(e){this.queue.push(e),this.run()}async run(){for(;this.running<this.maxConcurrent&&this.queue.length;){let e=this.queue.shift();this.running++;try{await _optionalChain([e, 'optionalCall', _2 => _2()])}catch(s){this.errors.push(s)}finally{this.running--,this.run()}}}async wait(){for(;this.running;)await new Promise(e=>setTimeout(e,0));if(y(this.errors))throw new $.default(this.errors,"failed")}};function U(i){return new N(i)}function le(i){return _core.types.isProgram(i.parent)||_core.types.isExportDefaultDeclaration(i.parent)||_core.types.isExportNamedDeclaration(i.parent)}var k=class{injectDependencies(e){this.dependencies=e,this.aliasesToDependencies=new Map,this.dependencies.forEach(({name:s,aliases:o})=>{this.aliasesToDependencies.set(s,s),y(o)&&o.forEach(t=>this.aliasesToDependencies.set(t,s))})}filter(e,s){let{output:o}=_rsmodulelexer.parse.call(void 0, {input:[{filename:s,code:e}]});if(!y(o))return!1;let{imports:t}=o[0],a=Array.from(new Set([...t.map(n=>n.n)]));for(let n of a)if(this.aliasesToDependencies.has(n))return!0;return!1}scanImportDeclarationAndRecord(e,s){let o=this.aliasesToDependencies.get(e.node.source.value),{global:t}=this.dependencies.get(o);for(let a of e.node.specifiers)switch(a.type){case"ImportDefaultSpecifier":case"ImportNamespaceSpecifier":s.set(a.local.name,`${t}.${a.type}.${o}`);break;case"ImportSpecifier":a.imported.type==="Identifier"&&s.set(a.local.name,`${t}.${a.imported.name}.${o}`)}}overWriteExportNamedDeclaration(e,s){let o=[],t=[],a=e.node.source,n=a?this.aliasesToDependencies.get(e.node.source.value):"",l=a&&n?this.dependencies.get(n).global:"",d=a&&n?this.dependencies.get(n).bindings:new Set,x=(c,f,g)=>{if(d.size){if(c.name==="default"&&c.name!==f.name){let p=h=>_core.types.memberExpression(_core.types.identifier(l),_core.types.identifier(h)),u=[...d.keys()].map(h=>_core.types.objectProperty(_core.types.identifier(h),p(h))),m=_core.types.variableDeclarator(_core.types.identifier(f.name),_core.types.objectExpression(u));o.push(m);return}if(f.name==="default"&&c.name!==f.name){let p=_core.types.memberExpression(_core.types.identifier(l),_core.types.identifier(c.name));o.push(p);return}if(c.name===f.name){if(c.name==="default"){let p=h=>_core.types.memberExpression(_core.types.identifier(l),_core.types.identifier(h)),u=[...d.keys()].map(h=>_core.types.objectProperty(_core.types.identifier(h),p(h))),m=_core.types.objectExpression(u);o.push(m);return}if(d.has(c.name)){let p=_core.types.memberExpression(_core.types.identifier(l),_core.types.identifier(c.name)),u=_core.types.variableDeclarator(_core.types.identifier(c.name),p);o.push(u);return}}t.push(g)}},b=(c,f,g)=>{if(s.has(c.name)){let[p,u,m]=s.get(c.name).split("."),h=(()=>{if(u==="ImportNamespaceSpecifier"){let A=P=>_core.types.memberExpression(_core.types.identifier(p),_core.types.identifier(P));return _core.types.objectExpression([...this.dependencies.get(m).bindings.keys()].map(P=>_core.types.objectProperty(_core.types.identifier(P),A(P))))}return _core.types.memberExpression(_core.types.identifier(p),_core.types.identifier(u))})();f.name==="default"?o.push(h):o.push(_core.types.variableDeclarator(_core.types.identifier(c.name),h));return}t.push(g)};for(let c of e.node.specifiers){if(c.type==="ExportSpecifier"){let{local:f,exported:g}=c;if(g.type!=="Identifier")continue;a?x(f,g,c):b(f,g,c)}if(c.type==="ExportNamespaceSpecifier"){let f=c.exported;if(f.name==="default"){let g=m=>_core.types.memberExpression(_core.types.identifier(l),_core.types.identifier(m)),p=[...d.keys()].map(m=>_core.types.objectProperty(_core.types.identifier(m),g(m))),u=_core.types.objectExpression(p);o.push(u)}else{let g=m=>_core.types.memberExpression(_core.types.identifier(l),_core.types.identifier(m)),p=[...d.keys()].map(m=>_core.types.objectProperty(_core.types.identifier(m),g(m))),u=_core.types.variableDeclarator(_core.types.identifier(f.name),_core.types.objectExpression(p));o.push(u)}}}let E=o.filter(c=>c.type==="VariableDeclarator"),M=o.filter(c=>c.type!=="VariableDeclarator");if(y(M)){let c=_core.types.exportDefaultDeclaration(M[0]);y(E)||y(t)?e.insertAfter(c):e.replaceWith(c)}if(y(E)){let c=_core.types.variableDeclaration("var",E);if(y(t)){let f=_core.types.exportNamedDeclaration(null,t);e.replaceWith(f),e.insertAfter(_core.types.exportNamedDeclaration(c,[]))}else e.replaceWith(_core.types.exportNamedDeclaration(c,[]))}}overWriteExportAllDeclaration(e){let s=[],o=this.aliasesToDependencies.get(e.node.source.value),{bindings:t}=this.dependencies.get(o);if(t.forEach(a=>{let n=_core.types.identifier(a),l=_core.types.exportSpecifier(n,n);s.push(l)}),y(s)){let a=_core.types.exportNamedDeclaration(null,s,_core.types.stringLiteral(e.node.source.value));e.replaceWith(a)}}eraseDuplicatedVariableDeclaration(e,s){if(!Array.isArray(e))return;let o=t=>{if(!Array.isArray(t)){if(_core.types.isVariableDeclarator(t.node)&&((_core.types.isObjectPattern(t.node.id)||_core.types.isArrayPattern(t.node.id))&&o(t.get("id")),_core.types.isRestElement(t.node.id)&&o(t.get("id.argument")),_core.types.isIdentifier(t.node.id))){let a=t.node.id.name;s.has(a)&&s.get(a).remove(),s.set(a,t);return}if(_core.types.isObjectPattern(t.node))for(let a of t.get("properties"))o(a);if(_core.types.isArrayPattern(t.node))for(let a of t.get("elements"))o(a)}};for(let t of e)o(t)}async transform(e){let s=await _core.parse.call(void 0, e,{babelrc:!1,configFile:!1}),o=new Map,t=new Map;_core.traverse.call(void 0, s,{ImportDeclaration:{enter:n=>{this.aliasesToDependencies.has(n.node.source.value)&&this.scanImportDeclarationAndRecord(n,o)},exit:n=>{this.aliasesToDependencies.has(n.node.source.value)&&(n.remove(),n.skip())}},ExportDeclaration:{enter:n=>{switch(n.node.type){case"ExportDefaultDeclaration":_core.types.isIdentifier(n.node.declaration)&&this.aliasesToDependencies.has(n.node.declaration.name)&&n.remove();break;case"ExportNamedDeclaration":(this.aliasesToDependencies.has(_optionalChain([n, 'access', _3 => _3.node, 'access', _4 => _4.source, 'optionalAccess', _5 => _5.value]))||!n.node.declaration)&&this.overWriteExportNamedDeclaration(n,o);break;case"ExportAllDeclaration":this.aliasesToDependencies.has(n.node.source.value)&&this.overWriteExportAllDeclaration(n)}}},Declaration:n=>{if(le(n)){if(_core.types.isClassDeclaration(n.node)||_core.types.isFunctionDeclaration(n.node)){let l=n.node.id.name;t.has(l)&&t.get(l).remove(),t.set(l,n)}_core.types.isVariableDeclaration(n.node)&&this.eraseDuplicatedVariableDeclaration(n.get("declarations"),t)}},Identifier:n=>{if(_core.types.isReferenced(n.node,n.parent)&&o.has(n.node.name)&&!n.scope.hasBinding(n.node.name)){let[l,d]=o.get(n.node.name).split(".");d==="ImportNamespaceSpecifier"||d==="ImportDefaultSpecifier"?n.node.name=l:n.node.name=[l,d].join("."),n.skip()}}});let a=await _core.transformFromAstAsync.call(void 0, s,"",{babelrc:!1,configFile:!1,sourceMaps:!0});return{code:a.code,map:a.map}}};function Se(){return new k}async function G(i){let e=await _core.parse.call(void 0, i,{babelrc:!1,configFile:!1}),{body:s}=e.program;if(!y(s))return;let o=s[0];if(_core.types.isVariableDeclaration(o)){let n=o.declarations[0].id;if(_core.types.isIdentifier(n))return n.name}let t=new Set,a="";return _core.traverse.call(void 0, e,{ExpressionStatement:n=>{if(_core.types.isCallExpression(n.node.expression)&&_core.types.isFunctionExpression(n.node.expression.callee)){let l=n.node.expression.callee.params;y(l)&&l.forEach(d=>{d.type==="Identifier"&&t.add(d.name)})}},AssignmentExpression:n=>{let l=n.get("left");if(l.node.type==="MemberExpression"&&(n.parent.type==="CallExpression"||n.parent.type==="ConditionalExpression"||n.parent.type==="ExpressionStatement")&&!a){if(_core.types.isIdentifier(l.node.object)&&!t.has(l.node.object.name)||!_core.types.isIdentifier(l.node.property)||l.node.property.name==="exports")return;a=l.node.property.name}n.skip()}}),a}var Q=_module2.default.createRequire(__meta.url),pe=_url2.default.fileURLToPath(__meta.url);function ue(i,e){let{port1:s,port2:o}=new _worker_threads2.default.MessageChannel,t=new _worker_threads2.default.Worker(pe,{workerData:{workerPort:o,internalThread:!0,scannerModule:i.modules,defaultWd:e},transferList:[o],execArgv:[]}),a=0;return t.unref(),(()=>{let l=new SharedArrayBuffer(4),d=new Int32Array(l);t.postMessage({sharedBuffer:l,id:a});let x=Atomics.wait(d,0,0);if(x!=="ok"&&x!=="not-equal")throw new Error("Internal error: Atomics.wait() failed: "+x);let{message:b}=_worker_threads2.default.receiveMessageOnPort(s);if(b.id!==a)throw new Error(`Internal error: Expected id ${a} but got id ${b.id}`);if(b.error)throw b.error;let{bindings:E,failedModules:M}=b;return E.forEach((c,f)=>{i.resolvers[f]&&(c.resolve=i.resolvers[f])}),{dependencies:E,failedModules:M}})()}function X(i,e=[]){return e.filter(s=>s!==".").map(s=>_path2.default.posix.join(i,s))}async function me(...i){let e;switch(y(i)){case 1:{let t=i[0];if(typeof t!="string")throw new Error("Invalid type");e=await I(_url2.default.pathToFileURL(t));break}case 2:{let[t,a]=i;if(typeof t!="object")throw new Error("Invalid type");let n=Q.resolve(t.name,{paths:[a]});e=await I(_url2.default.pathToFileURL(n));break}}let s=Object.keys(e);if(s.includes("default")&&y(s)!==1){let t=s.findIndex(a=>a==="default");s.splice(t,1),s.push(...Object.keys(e.default))}return new Set(s.filter(t=>t!=="__esModule"))}async function ge(i,e,s,o){let{name:t,relativeModule:a,aliases:n,...l}=i;try{let d=Q.resolve(t,{paths:[o]}),x=v(d,"package.json"),b=await _promises2.default.readFile(x,"utf8"),E=JSON.parse(b),{version:M,name:c,unpkg:f,jsdelivr:g}=E,p=Object.create(null),u=a||g||f;if(!u)throw new Error("try resolve file failed.");if(l.global)Object.assign(p,{name:c,version:M,relativeModule:u,aliases:X(c,n),...l});else{let h=v(x,u),A=await _promises2.default.readFile(h,"utf8");Object.assign(p,{name:c,version:M,code:A,relativeModule:u,aliases:X(c,n),...l})}let m=await me(d);e.set(c,{...p,bindings:m})}catch(d){let x=(()=>d instanceof Error?"code"in d&&d.code==="MODULE_NOT_FOUND"?"can't find module.":d.message:d)();s.set(t,x)}}function be(){if(!_worker_threads2.default.workerData.internalThread)return;let{workerPort:i,scannerModule:e,defaultWd:s}=_worker_threads2.default.workerData,{parentPort:o}=_worker_threads2.default,t=new Map,a=new Map;_optionalChain([o, 'optionalAccess', _6 => _6.on, 'call', _7 => _7("message",n=>{(async()=>{let{id:l,sharedBuffer:d}=n,x=new Int32Array(d);try{let b=new Map,E=U(L);for(let M of e)E.enqueue(()=>ge(M,t,a,s));await E.wait();for(let M of e){let{name:c}=M;if(t.has(c)){let{code:f,...g}=t.get(c);if(!f){b.set(c,g);continue}let p=await G(f);p?b.set(c,{...g,global:p}):a.set(c,"try resolve global name failed.")}}t.clear(),i.postMessage({bindings:b,id:l,failedModules:a})}catch(b){i.postMessage({error:b,id:l})}Atomics.add(x,0,1),Atomics.notify(x,0,1/0)})()})])}_optionalChain([_worker_threads2.default, 'access', _8 => _8.workerData, 'optionalAccess', _9 => _9.internalThread])&&be();var j=class{constructor(e){this.modules=e,this.dependencies=new Map,this.failedModules=new Map,this.defaultWd=process.cwd()}setDefaultWd(e){this.defaultWd=e}scanAllDependencies(){let e=ue(this.serialization(this.modules),this.defaultWd);this.dependencies=e.dependencies,this.failedModules=e.failedModules}serialization(e){V(Array.isArray(e),"vite-plugin-cdn2: option module must be array");let s=[],o={},t=new Set;for(let a of e){if(typeof a=="string"){if(t.has(a)||!a)continue;s.push({name:a}),t.add(a);continue}if(!a.name||t.has(a.name))continue;let{resolve:n,...l}=a;n&&(o[l.name]=n),s.push(l),t.add(a.name)}return{modules:s,resolvers:o}}};function _e(i){return new j(i)}exports.a = De; exports.b = Pe; exports.c = ve; exports.d = Se; exports.e = me; exports.f = _e;
