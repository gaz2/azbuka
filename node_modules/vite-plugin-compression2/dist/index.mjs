var et=Object.create;var z=Object.defineProperty;var rt=Object.getOwnPropertyDescriptor;var ot=Object.getOwnPropertyNames;var it=Object.getPrototypeOf,nt=Object.prototype.hasOwnProperty;var U=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var st=(t,e,i,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of ot(e))!nt.call(t,o)&&o!==i&&z(t,o,{get:()=>e[o],enumerable:!(r=rt(e,o))||r.enumerable});return t};var ut=(t,e,i)=>(i=t!=null?et(it(t)):{},st(e||!t||!t.__esModule?z(i,"default",{value:t,enumerable:!0}):i,t));var Q=U((Ft,w)=>{"use strict";var{bind:pt,call:at}=Function.prototype,lt=pt.bind(at);w.exports.uncurryThis=lt;var ft=Object.getPrototypeOf(Uint8Array.prototype);w.exports.TypedArrayPrototype=ft;var mt=(t,e,i,r)=>{if(e in t){if(r===!0){if(t[e]===i)return}else if(!(typeof r=="function"&&Object.prototype.toString.call(r)==="[object Function]")||!r())return}Object.defineProperty(t,e,{configurable:!0,enumerable:!1,value:i,writable:!0})},Z=(t,e,i={})=>{let r=Array.prototype.concat.call(Object.keys(e),Object.getOwnPropertySymbols(e));for(let o=0,u=r.length;o<u;o++)mt(t,r[o],e[r[o]],i[r[o]])};w.exports.defineProperties=Z;var gt=(t,e)=>Z(t,{implementation:e,getPolyfill:()=>e,shim:()=>e});w.exports.makeEsShim=gt});var G=U((vt,X)=>{"use strict";var{makeEsShim:ht}=Q(),Y=typeof AggregateError=="function"?AggregateError:(()=>{function t(e,i){let r=new Error(i);return Object.setPrototypeOf(r,t.prototype),delete r.constructor,Object.defineProperty(r,"errors",{value:Array.from(e)}),r}return Object.defineProperty(t,"prototype",{writable:!1}),Object.defineProperties(t.prototype,{constructor:{enumerable:!1,configurable:!0,writable:!0,value:t},message:{enumerable:!1,configurable:!0,writable:!0,value:""},name:{enumerable:!1,configurable:!0,writable:!0,value:"AggregateError"}}),Object.setPrototypeOf(t.prototype,Error.prototype),t})(),W=Y;ht(W,Y);X.exports=W});import j from"fs/promises";import dt from"fs";import yt from"os";import C from"path";import{createFilter as bt}from"@rollup/pluginutils";import v from"fs/promises";import k from"path";function f(t){return t.length}function B(t,e){let i=typeof e=="function"?e(t):e,{dir:r,base:o}=k.parse(t),u=r?r+"/":"";return i.replace(/\[path\]/,u).replace(/\[base\]/,o)}function _(t){return/^\\\\\?\\/.test(t)?t:t.replace(/\\/g,"/")}async function D(t){let e=await Promise.all((await v.readdir(t)).map(o=>k.join(t,o))),i=0,r=[];for(;i!==f(e);){let o=e[i],u=await v.stat(o);if(u.isDirectory()){let x=await v.readdir(o);e.push(...x.map(E=>k.join(o,E)))}u.isFile()&&r.push(o),i++}return r}import b from"zlib";import ct from"util";function V(t){let e=t in b?t:"gzip";return{algorithm:ct.promisify(b[e])}}async function R(t,e,i){try{let r=await e(t,i);return Buffer.isBuffer(r)?r:Buffer.from(r)}catch(r){return Promise.reject(r)}}var L={gzip:{level:b.constants.Z_BEST_COMPRESSION},brotliCompress:{params:{[b.constants.BROTLI_PARAM_QUALITY]:b.constants.BROTLI_MAX_QUALITY}},deflate:{level:b.constants.Z_BEST_COMPRESSION},deflateRaw:{level:b.constants.Z_BEST_COMPRESSION}};var H=ut(G());var M=class{constructor(e){this.maxConcurrent=e,this.queue=[],this.errors=[],this.running=0}enqueue(e){this.queue.push(e),this.run()}async run(){for(;this.running<this.maxConcurrent&&this.queue.length;){let e=this.queue.shift();this.running++;try{await e()}catch(i){this.errors.push(i)}finally{this.running--,this.run()}}}async wait(){for(;this.running;)await new Promise(e=>setTimeout(e,0));if(f(this.errors))throw new H.default(this.errors,"task failed")}};function J(t){return new M(t)}var Ot="copyPublicDir",Ct=(()=>{let t=yt.cpus()||{length:1};return t.length===1?10:Math.max(1,t.length-1)})();function Pt(t,e){var r;let i=(o,u)=>C.resolve(o,u);if((r=t.build.rollupOptions)!=null&&r.output){(Array.isArray(t.build.rollupOptions.output)?t.build.rollupOptions.output:[t.build.rollupOptions.output]).forEach(u=>{typeof u=="object"&&!f(Object.keys(u))||e.add(i(t.root,u.dir||t.build.outDir))});return}e.add(i(t.root,t.build.outDir))}function S(t,e){let i=[],r=[];return t.forEach(o=>{i.push(o),r.push(_(C.join(o,e)))}),{dests:i,files:r}}function At(t={}){let{include:e,exclude:i,threshold:r=0,algorithm:o="gzip",filename:u,compressionOptions:x,deleteOriginalAssets:E=!1,skipIfLargerOrEqual:N=!1}=t,I=bt(e,i),g=new Map,P=new Set,h=Object.create(null);h.algorithm=typeof o=="string"?V(o).algorithm:o,h.options=typeof o=="function"?x:Object.assign(L[o],x),h.filename=u!=null?u:o==="brotliCompress"?"[path][base].br":"[path][base].gz";let T=J(Ct);return{name:"vite-plugin-compression",apply:"build",enforce:"post",async configResolved(a){Pt(a,P);let c=Ot in a.build?a.build.copyPublicDir:!0;if(a.publicDir&&c&&dt.existsSync(a.publicDir)){let d=await D(a.publicDir),n=C.join(a.root,C.relative(a.root,a.publicDir));Promise.all(d.map(async s=>{if(!I(s))return;let{size:l}=await j.stat(s);if(l<r)return;let m=C.relative(n,s),{files:p,dests:y}=S(P,m);g.set(_(m),{effect:!0,file:p,dest:y})}))}},async generateBundle(a,c){for(let n in c){if(!I(n))continue;let s=c[n],l=s.type==="asset"?s.source:s.code;if(f(l)<r)continue;let p=Object.create(null);if(s.type==="chunk"&&f(s.dynamicImports)){p.effect=!0;let{dests:y,files:O}=S(P,n);p.effect&&(p.dest=y,p.file=O),s.dynamicImports.forEach(A=>{if(I(A)&&A in c){let F=c[A],K=F.type==="asset"?F.source:F.code;if(f(K)<r)return;let{dests:$,files:tt}=S(P,A);g.set(A,{effect:!0,file:tt,dest:$})}})}else p.effect=!1;!g.has(n)&&s&&g.set(n,p)}let d=async(n,s)=>{if(s.effect)return;let l=c[n],m=B(n,h.filename);if(n===m&&l.type==="chunk"){let{dests:O,files:q}=S(P,m);g.set(n,{effect:!0,file:q,dest:O});return}let p=Buffer.from(l.type==="asset"?l.source:l.code),y=await R(p,h.algorithm,h.options);N&&f(y)>=f(p)||(E&&Reflect.deleteProperty(c,n),this.emitFile({type:"asset",source:y,fileName:m}),g.delete(n))};g.forEach((n,s)=>T.enqueue(()=>d(s,n))),await T.wait().catch(this.error)},async closeBundle(){let a=async(c,d)=>{if(d.effect)for(let[n,s]of d.dest.entries()){let l=d.file[n],m=await j.readFile(l),p=await R(m,h.algorithm,h.options);if(N&&f(p)>=f(m))continue;let y=B(c,h.filename),O=C.join(s,y);E&&O!==l&&await j.rm(l,{recursive:!0,force:!0}),await j.writeFile(O,p)}};g.forEach((c,d)=>T.enqueue(()=>a(d,c))),await T.wait().catch(c=>c),g.clear()}}}var Vt=At;export{At as compression,Vt as default};
